<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Firebase)</title>
    
    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        /* --- (same styling as the original file) --- */
        * { margin:0; padding:0; box-sizing:border-box; }
        :root{ --primary-green:#2E7D32; --secondary-green:#4CAF50; --accent-yellow:#FFD700; --light-green:#E8F5E8; --dark-green:#1B5E20; --text-dark:#2C3E50; --text-light:#7F8C8D; --white:#FFFFFF; --shadow:0 4px 20px rgba(0,0,0,0.1); --border-radius:15px; }
        body{ font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,var(--primary-green),var(--secondary-green)); min-height:100vh; overflow-x:hidden; }
        .animated-bg{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; overflow:hidden; }
        .floating-shape{ position:absolute; background:rgba(255,255,255,0.08); border-radius:50%; animation:float 20s infinite linear; }
        .floating-shape:nth-child(1){ width:80px; height:80px; top:10%; left:10%; }
        .floating-shape:nth-child(2){ width:120px; height:120px; top:70%; left:80%; }
        .floating-shape:nth-child(3){ width:60px; height:60px; top:40%; left:70%; }
        .floating-shape:nth-child(4){ width:100px; height:100px; top:80%; left:20%; }
        @keyframes float{ 0%{ transform:translateY(0px) rotate(0deg); opacity:0.7; } 50%{ transform:translateY(-20px) rotate(180deg); opacity:0.3; } 100%{ transform:translateY(0px) rotate(360deg); opacity:0.7; } }
        .login-container{ display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
        .login-box{ background:var(--white); border-radius:var(--border-radius); box-shadow:var(--shadow); padding:40px; width:100%; max-width:450px; text-align:center; }
        .school-logo{ width:80px; height:80px; margin:0 auto 20px; background:linear-gradient(135deg,var(--primary-green),var(--secondary-green)); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2.5rem; }
        .login-title{ font-size:2rem; color:var(--text-dark); margin-bottom:10px; background:linear-gradient(135deg,var(--primary-green),var(--secondary-green)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .login-subtitle{ color:var(--text-light); margin-bottom:30px; font-size:1.1rem; }
        .form-group{ margin-bottom:20px; text-align:left; }
        .form-group label{ display:block; margin-bottom:8px; color:var(--text-dark); font-weight:600; }
        .form-control{ width:100%; padding:15px; border:2px solid #E0E0E0; border-radius:10px; font-size:16px; background:var(--white); }
        .form-control:focus{ outline:none; border-color:var(--secondary-green); box-shadow:0 0 0 3px rgba(76,175,80,0.1); }
        .btn-primary{ width:100%; padding:15px; background:linear-gradient(135deg,var(--primary-green),var(--secondary-green)); color:var(--white); border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; }
        .hidden{ display:none !important; }
        .dashboard{ display:none; min-height:100vh; background:#F8F9FA; }
        .dashboard.active{ display:block; }
        .navbar{ background:var(--white); box-shadow:var(--shadow); padding:15px 0; position:sticky; top:0; z-index:100; }
        .navbar-content{ max-width:1200px; margin:0 auto; padding:0 20px; display:flex; justify-content:space-between; align-items:center; }
        .navbar-title{ font-size:1.5rem; font-weight:bold; color:var(--text-dark); }
        .btn-logout{ background:linear-gradient(135deg,#E74C3C,#C0392B); color:var(--white); border:none; padding:8px 16px; border-radius:20px; cursor:pointer; }
        .main-content{ max-width:1200px; margin:0 auto; padding:30px 20px; }
        .page-title{ font-size:2rem; color:var(--text-dark); margin-bottom:10px; }
        .nav-tabs{ display:flex; gap:10px; margin-bottom:30px; flex-wrap:wrap; }
        .nav-tab{ padding:12px 24px; background:var(--white); border-radius:25px; cursor:pointer; color:var(--text-dark); font-weight:500; }
        .nav-tab.active{ background:linear-gradient(135deg,var(--primary-green),var(--secondary-green)); color:var(--white); }
        .card{ background:var(--white); border-radius:var(--border-radius); box-shadow:var(--shadow); padding:25px; margin-bottom:20px; }
        .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card{ background:linear-gradient(135deg,var(--primary-green),var(--secondary-green)); color:var(--white); padding:25px; border-radius:var(--border-radius); text-align:center; }
        .stat-value{ font-size:3rem; font-weight:bold; }
        .chart-container{ position:relative; height:400px; margin:20px 0; }
        .table-responsive{ overflow-x:auto; border-radius:var(--border-radius); box-shadow:var(--shadow); }
        .table{ width:100%; background:var(--white); border-collapse:collapse; }
        .table th, .table td{ padding:15px; text-align:left; border-bottom:1px solid #E0E0E0; }
        .status-badge{ padding:4px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; }
        .status-present{ background:#D4EDDA; color:#155724; }
        .status-absent{ background:#F8D7DA; color:#721C24; }
        .status-late{ background:#FFF3CD; color:#856404; }
        .notification{ position:fixed; top:20px; right:20px; background:var(--white); border-left:4px solid var(--secondary-green); border-radius:8px; padding:15px 20px; box-shadow:var(--shadow); z-index:1000; }
    </style>
</head>
<body>
    <div class="animated-bg">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <!-- Login -->
    <div id="loginSection" class="login-container">
        <div class="login-box">
            <div class="school-logo">üéì</div>
            <h1 class="login-title">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</h1>
            <p class="login-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Firebase):</label>
                    <input type="text" id="username" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" required>
                </div>
                <div class="form-group">
                    <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
                    <input type="password" id="password" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                </div>
                <div class="form-group">
                    <label for="role">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á):</label>
                    <select id="role" class="form-control">
                        <option value="">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option>
                        <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                        <option value="teacher">‡∏Ñ‡∏£‡∏π</option>
                        <option value="student">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">
                    <span id="loginText">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    <span id="loginSpinner" class="loading-spinner hidden"></span>
                </button>
            </form>

            <p style="margin-top:12px; color:var(--text-light); font-size:0.9rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà" ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î (‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô Firebase Console)</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardSection" class="dashboard">
        <nav class="navbar">
            <div class="navbar-content">
                <div style="display:flex; gap:12px; align-items:center;">
                    <div class="navbar-logo">üéì</div>
                    <div class="navbar-title">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="text-align:right;">
                        <div id="userName" style="font-weight:600; color:var(--text-dark);">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
                        <div id="userRole" style="font-size:0.9rem; color:var(--text-light);">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <button class="btn-logout" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </nav>

        <div class="main-content">
            <div class="page-header">
                <h1 class="page-title" id="pageTitle">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
                <p class="page-subtitle" id="pageSubtitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            </div>

            <div class="nav-tabs" id="navTabs"></div>
            <div id="tabContent"></div>
        </div>
    </div>

    <!-- User Modal (add user) -->
    <div id="userModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
                <button class="close-btn" onclick="closeModal('userModal')">&times;</button>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label for="newUsername">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ e-mail):</label>
                    <input type="text" id="newUsername" class="form-control">
                </div>
                <div class="form-group">
                    <label for="newName">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
                    <input type="text" id="newName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="newEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö):</label>
                    <input type="email" id="newEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="newRole">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</label>
                    <select id="newRole" class="form-control" required>
                        <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                        <option value="teacher">‡∏Ñ‡∏£‡∏π</option>
                        <option value="student" selected>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
                    <input type="password" id="newPassword" class="form-control" required>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button type="submit" class="btn btn-success">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn" onclick="closeModal('userModal')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        /* ---------- Firebase config (REPLACE with the config you gave) ---------- */
        const firebaseConfig = {
          apiKey: "AIzaSyD80WK9Mx-QjXp3lOwIDCIrfLoXoODlzlg",
          authDomain: "check-name-blh.firebaseapp.com",
          databaseURL: "https://check-name-blh-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "check-name-blh",
          storageBucket: "check-name-blh.firebasestorage.app",
          messagingSenderId: "420973526100",
          appId: "1:420973526100:web:b7a382f4784382e51281c1",
          measurementId: "G-86R88K64SC"
        };

        // Initialize Firebase
        let db = null;
        let auth = null;
        let isFirebaseEnabled = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            isFirebaseEnabled = true;
            console.log('Firebase initialized');
        } catch (err) {
            console.warn('Firebase init failed, switching to demo mode', err);
            isFirebaseEnabled = false;
        }

        // Global state
        let currentUser = null; // uid when firebase enabled, else username
        let currentUserData = null;

        // Demo fallback data (kept for offline/testing)
        let demoUsers = {
            'admin': { username: 'admin', password: CryptoJS.SHA256('admin123').toString(), name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö ‡∏™‡∏°‡∏ä‡∏≤‡∏¢', email: 'admin@school.com', role: 'admin' }
        };

        /* ----------------- Helpers ----------------- */
        function showNotification(message, type='success'){
            const existing = document.querySelector('.notification'); if (existing) existing.remove();
            const n = document.createElement('div'); n.className = 'notification'; n.innerHTML = `<div style="display:flex;gap:10px;align-items:center;">${type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ö†Ô∏è'} <span>${message}</span></div>`;
            document.body.appendChild(n);
            setTimeout(()=>{ n.remove(); },5000);
        }

        function showModal(id){ document.getElementById(id).style.display = 'flex'; }
        function closeModal(id){ document.getElementById(id).style.display = 'none'; }

        /* ----------------- Database wrappers (Firestore first) ----------------- */
        async function saveToDatabase(collection, docId, data){
            if (isFirebaseEnabled){
                try{
                    await db.collection(collection).doc(docId).set(data, { merge: true });
                    return true;
                }catch(err){ console.error('saveToDatabase error', err); return false; }
            } else {
                // demo fallback (in-memory)
                if (collection === 'users') demoUsers[docId] = data;
                return true;
            }
        }

        async function getFromDatabase(collection, docId=null){
            if (isFirebaseEnabled){
                try{
                    if (docId){
                        const doc = await db.collection(collection).doc(docId).get();
                        return doc.exists ? doc.data() : null;
                    } else {
                        const snap = await db.collection(collection).get();
                        const out = {};
                        snap.forEach(d=> out[d.id] = d.data());
                        return out;
                    }
                }catch(err){ console.error('getFromDatabase error', err); return null; }
            } else {
                if (collection === 'users') return docId ? demoUsers[docId] : demoUsers;
                return null;
            }
        }

        async function deleteFromDatabase(collection, docId){
            if (isFirebaseEnabled){
                try{ await db.collection(collection).doc(docId).delete(); return true; }catch(err){ console.error(err); return false; }
            } else {
                if (collection === 'users') delete demoUsers[docId]; return true;
            }
        }

        /* ----------------- Authentication & UI flow ----------------- */
        // Listen for auth state changes
        if (isFirebaseEnabled){
            auth.onAuthStateChanged(async (user) => {
                if (user){
                    currentUser = user.uid;
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists){ currentUserData = doc.data(); }
                    else {
                        // create minimal profile
                        currentUserData = { name: user.email, email: user.email, role: 'student' };
                        await db.collection('users').doc(user.uid).set(currentUserData);
                    }
                    postLogin();
                } else {
                    currentUser = null; currentUserData = null;
                    document.getElementById('loginSection').style.display = 'flex';
                    document.getElementById('dashboardSection').classList.remove('active');
                }
            });
        }

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const roleSelect = document.getElementById('role').value;

            if (isFirebaseEnabled){
                // require e-mail login when using Firebase Auth
                if (!username.includes('@')){
                    showNotification('‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Firebase ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (username)', 'error');
                    return;
                }
                try{
                    document.getElementById('loginSpinner').classList.remove('hidden');
                    document.getElementById('loginText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
                    const userCred = await auth.signInWithEmailAndPassword(username, password);
                    // onAuthStateChanged will handle UI update
                }catch(err){
                    console.error(err);
                    showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (err.message || err), 'error');
                }finally{
                    document.getElementById('loginSpinner').classList.add('hidden');
                    document.getElementById('loginText').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                }
            } else {
                // Demo fallback: username-based
                const hashed = CryptoJS.SHA256(password).toString();
                const user = demoUsers[username];
                if (user && user.password === hashed){
                    currentUser = username; currentUserData = user; postLogin();
                } else {
                    showNotification('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (demo)', 'error');
                }
            }
        });

        // Post login UI setup
        function postLogin(){
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.add('active');
            document.getElementById('userName').textContent = currentUserData.name || currentUserData.email || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            document.getElementById('userRole').textContent = currentUserData.role || '';
            generateNavTabs(currentUserData.role || 'student');
            showTab('dashboard');
            showNotification('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + (currentUserData.name || currentUserData.email), 'success');
        }

        async function logout(){
            if (isFirebaseEnabled){
                try{ await auth.signOut(); }catch(err){ console.error(err); }
            }
            currentUser = null; currentUserData = null;
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('dashboardSection').classList.remove('active');
        }

        /* ----------------- User creation (register) ----------------- */
        document.getElementById('userForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const newUsername = document.getElementById('newUsername').value.trim();
            const newName = document.getElementById('newName').value.trim();
            const newEmail = document.getElementById('newEmail').value.trim();
            const newRole = document.getElementById('newRole').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!newEmail || !newPassword || !newName){ showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error'); return; }

            if (isFirebaseEnabled){
                try{
                    const userCred = await auth.createUserWithEmailAndPassword(newEmail, newPassword);
                    const uid = userCred.user.uid;
                    const profile = { name: newName, email: newEmail, role: newRole };
                    await db.collection('users').doc(uid).set(profile);
                    showNotification('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (uid: ' + uid + ')', 'success');
                    closeModal('userModal');
                }catch(err){ console.error(err); showNotification('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (err.message||err), 'error'); }
            } else {
                // demo mode: save to in-memory demoUsers keyed by username
                if (!newUsername){ showNotification('‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î demo ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (username)', 'error'); return; }
                demoUsers[newUsername] = { username: newUsername, password: CryptoJS.SHA256(newPassword).toString(), name: newName, email: newEmail, role: newRole };
                showNotification('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ demo ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                closeModal('userModal');
            }
        });

        /* ----------------- Navigation ----------------- */
        function generateNavTabs(role){
            const nav = document.getElementById('navTabs'); nav.innerHTML = '';
            const base = [ 'dashboard', 'attendance', 'reports', 'subjects', 'profile' ];
            const adminOnly = [ 'users', 'settings' ];
            const tabs = role === 'admin' ? base.concat(adminOnly) : base;
            const labels = { dashboard:'‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î', attendance:'‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠', reports:'‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', subjects:'‡∏ß‡∏¥‡∏ä‡∏≤', users:'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', settings:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', profile:'‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå' };
            tabs.forEach((t,i)=>{
                const btn = document.createElement('button'); btn.className = 'nav-tab' + (i===0?' active':''); btn.textContent = labels[t] || t; btn.onclick = ()=> showTab(t); nav.appendChild(btn);
            });
        }

        function showTab(tabName){
            document.querySelectorAll('.nav-tab').forEach(tb=> tb.classList.remove('active'));
            Array.from(document.querySelectorAll('.nav-tab')).find(b=>b.textContent===tabName || b.onclick && b.onclick.toString().includes("showTab('"+tabName+"')"))?.classList.add('active');
            loadTabContent(tabName);
        }

        /* ----------------- Basic Tab loaders (kept simple / demo) ----------------- */
        function loadTabContent(tabName){
            const content = document.getElementById('tabContent');
            switch(tabName){
                case 'dashboard': loadDashboard(); break;
                case 'attendance': loadAttendance(); break;
                case 'reports': loadReports(); break;
                case 'subjects': loadSubjects(); break;
                case 'users': loadUsers(); break;
                case 'settings': loadSettings(); break;
                case 'profile': loadProfile(); break;
                default: content.innerHTML = '<div class="card"><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</h3></div>';
            }
        }

        function loadDashboard(){
            const content = document.getElementById('tabContent');
            let statsHTML = '';
            if ((currentUserData.role||'').toLowerCase() === 'admin'){
                statsHTML = `<div class="stats-grid"> <div class="stat-card"><div class="stat-value">--</div><div class="stat-label">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div><div class="stat-card"><div class="stat-value">--</div><div class="stat-label">‡∏Ñ‡∏£‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div></div>`;
            } else if ((currentUserData.role||'').toLowerCase()==='teacher'){
                statsHTML = `<div class="stats-grid"><div class="stat-card"><div class="stat-value">--</div><div class="stat-label">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô</div></div></div>`;
            } else {
                statsHTML = `<div class="stats-grid"><div class="stat-card"><div class="stat-value">--</div><div class="stat-label">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div></div></div>`;
            }
            content.innerHTML = ` ${statsHTML} <div class="card"><div class="card-header"><h3 class="card-title">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</h3></div><div class="chart-container"><canvas id="attendanceChart"></canvas></div></div>`;
            setTimeout(()=> loadAttendanceChart(), 100);
        }

        function loadAttendanceChart(){
            const ctx = document.getElementById('attendanceChart'); if (!ctx) return;
            new Chart(ctx, {
                type: 'line', data: { labels:['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå','‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'], datasets:[{ label:'‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', data:[120,130,125,140,135,0,0], borderColor:'rgb(76,175,80)', backgroundColor:'rgba(76,175,80,0.1)', tension:0.4 }] },
                options:{ responsive:true, maintainAspectRatio:false }
            });
        }

        function loadAttendance(){
            const content = document.getElementById('tabContent');
            if ((currentUserData.role||'') === 'teacher'){
                content.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">üìù ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3></div><div style="padding:20px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠</div></div>`;
            } else if ((currentUserData.role||'') === 'student'){
                content.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3></div><div style="padding:20px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div></div>`;
            } else {
                content.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3></div><div style="padding:20px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div></div>`;
            }
        }

        function loadReports(){ document.getElementById('tabContent').innerHTML = `<div class="card"><h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏ó‡∏î‡∏•‡∏≠‡∏á)</h3></div>`; }
        function loadSubjects(){ document.getElementById('tabContent').innerHTML = `<div class="card"><h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3><button class="btn btn-success" onclick="showModal('userModal')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</button></div>`; }
        function loadUsers(){
            if ((currentUserData.role||'') !== 'admin'){ document.getElementById('tabContent').innerHTML = `<div class="card"><h3>üö´ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</h3></div>`; return; }
            document.getElementById('tabContent').innerHTML = `<div class="card"><h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å Firestore)</h3><div id="usersList">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>`;
            // load users list
            (async ()=>{
                const users = await getFromDatabase('users');
                const listEl = document.getElementById('usersList');
                if (!users) { listEl.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; return; }
                listEl.innerHTML = Object.keys(users).map(uid=>{
                    const u = users[uid];
                    return `<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;"><div><strong>${u.name||u.email||uid}</strong><br><small>${u.email||''} | ${u.role||''}</small></div><div><button class="btn" onclick="editUser('${uid}')">‚úèÔ∏è</button><button class="btn" onclick="deleteUserConfirm('${uid}')">üóëÔ∏è</button></div></div>`;
                }).join('');
            })();
        }

        function editUser(uid){ showNotification('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning'); }
        async function deleteUserConfirm(uid){ if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; await deleteFromDatabase('users', uid); showNotification('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); loadUsers(); }

        function loadSettings(){ if ((currentUserData.role||'')!=='admin'){ document.getElementById('tabContent').innerHTML = `<div class="card"><h3>üö´ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</h3></div>`; return; } document.getElementById('tabContent').innerHTML = `<div class="card"><h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3></div>`; }
        function loadProfile(){ document.getElementById('tabContent').innerHTML = `<div class="card"><h3>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3><p>‡∏ä‡∏∑‡πà‡∏≠: ${currentUserData.name||''}</p><p>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${currentUserData.email||''}</p><p>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ${currentUserData.role||''}</p></div>`; }

        /* ----------------- Utility on load ----------------- */
        // If firebase is not enabled, show demo warning
        if (!isFirebaseEnabled){
            showNotification('Firebase ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ ‚Äî ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î demo', 'warning');
        }

        // Small helper to open add-user modal from UI
        function showAddUserModal(){ showModal('userModal'); }

    </script>
</body>
</html>
